---
# Run basic tests for this app on the latest aiidalab-docker image.

name: continuous-integration

on: [push, pull_request]

jobs:

    build-docker-container:

        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Build Docker image
              uses: docker/build-push-action@v2
              with:
                  context: tests
                  push: false
                  tags: aiidalab/full-stack-with-browsers:latest

    test-notebooks:

        needs: [build-docker-container]

        strategy:
            matrix:
                tag: [latest]
                browser: [Chrome]
                python-version: ['3.10']
            fail-fast: false

        runs-on: ubuntu-latest
        container:
            image: aiidalab/full-stack-with-browsers:latest
            env:
                RMQHOST: messaging
                TZ: Europe/Zurich
                DOCKER_STACKS_JUPYTER_CMD: notebook
                SETUP_DEFAULT_AIIDA_PROFILE: true
                JUPYTER_TOKEN: my_test_token
            volumes:
                - ./:/home/jovyan/apps/aiidalab-widgets-base
        timeout-minutes: 30

        steps:

            - name: Checkout repository
              uses: actions/checkout@v2

            - name: Enter the repository
              run: cd apps/aiidalab-widgets-base

            - name: Install package
              run: pip install -e .[dev,smiles]

            - name: Run pytest
              run: pytest -v --driver ${{ matrix.browser }}
              env:
                  TAG: ${{ matrix.tag }}

            - name: Upload screenshots as artifacts
              if: always()
              uses: actions/upload-artifact@v3
              with:
                  name: Screenshots-${{ matrix.tag }}-${{ matrix.browser }}
                  path: screenshots/
                  if-no-files-found: error
